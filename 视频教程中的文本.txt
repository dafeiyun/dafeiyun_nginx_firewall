大飞云nginx驱动防火墙安装教程
说明:大飞云nginx驱动防火墙 可以实现对每个nginx上网站实现第七层CC防御 并且由我们魔改版的nginx可以自动检测cc攻击并且可以调用iptables ipset命令在网络层屏蔽ip访问  ，实测物理服务器E3-1230V2  100M下行宽带可以实现无视CC效果！
Telegram群:@dfy888   网站dafeiyun.com    作者Telegram:@dafeiyun     是免费的不收费
================================================================，目前支持centos7.X系统 ，理论是可以支持debain和ubuntu的 但是最近忙没时间去弄debain和ubuntu

dafeiyun_fw.ko是驱动防火墙内核文件
ipv4是驱动防火墙白名单文件
tcp.sh是驱动防火墙调用文件

这3个文件必须放在home目录里面，现在nginx编译好了 我们替换nginx文件为我们的魔改nginx
位置是 /www/server/nginx/sbin/   删除原有的nginx文件  上传我们的魔改nginx文件，看能不能正常启动，启动是没问题的 ，

因为linux5.15内核是自带bbr加速的 ，可以bbr加速也开一下 
> /etc/sysctl.conf  先清空原有sysctl.conf规则
echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
sysctl -p  好了，现在bbr开启了 

1，第一步 先更换系统内核，先把我们提供的内核上传到root目录
查询系统中所有内核rpm -qa | grep kernel  卸载内核
rpm --nodeps -e kernel-tools-3.10.0-327.el7.x86_64
然后安装新内核yum install -y     设置新内核启动grub2-set-default 0
 这里等一下 ，然后reboot命令重启服务器，现在内核是5.15启动的了
2，安装必要的依赖项yum install -y net-tools和yum -y install iptables和yum -y install ipset
3，然后进入宝塔选择编译安装nginx1.22一次，我这里安装过了 现在卸载一下 重新安装

接下来就是屏蔽ip设置 ，因为iptables和ipset每次服务器重启 规则都会无效  所以我们要把规则加入到开机启动 ，我们看看重启这些规则是否随开机也启动了，是启动了

echo "iptables -F">>/etc/rc.d/rc.local
echo "ipset create dafeiyun hash:ip timeout 3600 maxelem 1000000">>/etc/rc.d/rc.local
echo "iptables -I INPUT -m set --match-set dafeiyun src -j DROP">>/etc/rc.d/rc.local
echo "insmod /home/dafeiyun_fw.ko">>/etc/rc.d/rc.local
chmod +x /etc/rc.d/rc.local
这里3600代表屏蔽ip时间3600秒是1小时  ，可以自己改也可以3600 

现在配置魔改版nginx防火墙 ，这里要改成root启动  不然防火墙会权限不足 ，把全局白名单文件植入nginx配置文件里 ，dafeiyun_waf_whitelist "/home/ipv4"; 这个白名单包含了什么百度蜘蛛，谷歌蜘蛛啊等所有搜索引擎ip段和cf cdn的ip段，然后重启服务器

接下来就是对单独网站设置cc防御和规则 


dafeiyun_waf on;   这里on是开关  on代表开启cc   off是关闭
dafeiyun_waf_model 2;  这里有3个模式 ，1是无感 ，2是点击验证 3是验证码
dafeiyun_waf_only_get on;  这里on是访问js验证只允许get访问  其他访问直接iptables封ip
dafeiyun_waf_max 5;  这里5是代表如果访问5次还解不开js验证 直接iptables封ip

每次修改完都需要重启nginx生效 ，这里是设置的2模式 也就是点击验证 ，也可以设置3是验证码墙，都是可以的，也可以设置1是无感 ，都是可以的，网站后面出现尾巴是正常的 是防火墙验证参数 ，
 
通过ipset命令可以，这里还没有屏蔽ip所以是空的 
查看ipset的屏蔽ip列表 ipset list dafeiyun
删除ipset的单个屏蔽ip列表ipset del dafeiyun 1.1.1.1
删除ipset的所有屏蔽ip列表ipset flush dafeiyun

Telegram群:@dfy888   网站dafeiyun.com    作者Telegram:@dafeiyun 

还有很多规则 ，比如指定目录不开启cc防御 不拦截api等支付接口方法 一时间讲不完那，可以来Telegram群:@dfy888来交流 ，，实测物理服务器E3-1230V2  100M下行宽带可以实现无视CC效果！
